@page "/"
@rendermode InteractiveServer
@inject NavigationManager Navigation

<PageTitle>Home</PageTitle>

<MudText  Typo="Typo.h1" GutterBottom="true">Upload file</MudText>


<MudGrid>
    <MudItem xs="6">
        <div Class>
            <MudText Typo="Typo.h5">Most Active Reader:</MudText>
            <MudText Class="pl-2">@getMostActiveReader() </MudText>
            <MudText Typo="Typo.h5">Most Active User:</MudText>
            <MudText Class="pl-2">@getMostActiveUser() </MudText>
            <MudText Typo="Typo.h5">Average Unique scans per day:</MudText>
            <MudText Class="pl-2">@getAverageActivity() </MudText>
            <MudText Typo="Typo.h5">Busiest Day of the Week:</MudText>
            <MudText Class="pl-2">@getMostActiveDayOfWeek() </MudText>
        </div>
    </MudItem>

</MudGrid>

<div>
    <MudText>Scans over Time @chartStartDate / @chartEndDate</MudText>
    @if(DictionariesCreated){
        <MudChart Class="align-content-center" ChartType="ChartType.Line" ChartSeries="@getChartData()" XAxisLabels="@getChartLabels()" AxisChartOptions="axisChartOptions" Width="100%" Height="400px"></MudChart>
    }
</div>


@code{
    public static bool DictionariesCreated = false;
    public string ErrorMessage { get; set; } = "";
    public string FileName {get; set;} = "";
    const int MAX_FILESIZE = 50000 * 1024;
    public AxisChartOptions axisChartOptions = new AxisChartOptions(); 
    public string chartStartDate = "";
    public string chartEndDate = "";


    public string getMostActiveReader()
    {
        string mostActiveReader = "";
        int mostActiveCount = 0;
        if(DictionariesCreated)
        {
            foreach(KeyValuePair<int, List<ReaderEvent>> r in FileStorage.ReaderDictionary)
            {
                if(r.Value.Count() > mostActiveCount){
                    mostActiveCount = r.Value.Count();
                    mostActiveReader = r.Value[0].ReaderDescription;
                }
            }
        }
        return mostActiveReader;
    }

    public string getMostActiveUser()
    {
        string mostActiveUser = "";
        int mostActiveCount = 0;
        if(DictionariesCreated)
        {
            foreach(KeyValuePair<string, List<ReaderEvent>> r in FileStorage.HashDictionary)
            {
                int valueCount = r.Value.Count();
                if(valueCount > mostActiveCount){
                    mostActiveCount = valueCount;
                    mostActiveUser = r.Key;
                }
            }
        }
        return mostActiveUser;
    }
    
    public float getAverageActivity()
    {
        if(DictionariesCreated)
        {
        List<int> UniqueCounts = new List<int>();
        List<string> hashSeen = new List<string>();
        foreach(KeyValuePair<string, List<ReaderEvent>> r in FileStorage.DateDictionary)
        {
            
            UniqueCounts.Add(0);
            foreach(ReaderEvent e in r.Value)
            {
                if(!hashSeen.Contains(e.IDHash))
                {
                    UniqueCounts[UniqueCounts.Count - 1] ++;
                    hashSeen.Add(e.IDHash);
                }
            }
            hashSeen.Clear();
        }

        int totalUniqueCounted = 0;
        foreach(int i in UniqueCounts)
        {
            totalUniqueCounted += i;
        }
        return totalUniqueCounted / FileStorage.DateDictionary.Count();
        }
        return 0;
    }

    public DayOfWeek getMostActiveDayOfWeek()
    {
        DayOfWeek mostActiveDay = DayOfWeek.Sunday;
        if(DictionariesCreated)
        {
            Dictionary<DayOfWeek, List<ReaderEvent>> D = new Dictionary<DayOfWeek, List<ReaderEvent>>();
            Dictionary<DayOfWeek, int> dayCounts = new Dictionary<DayOfWeek, int>();
            foreach(KeyValuePair<string, List<ReaderEvent>> value in FileStorage.DateDictionary)
            {
                DayOfWeek day = value.Value.First().EventTimeStamp.DayOfWeek;
                foreach(ReaderEvent e in value.Value)
                {
                    if(D.ContainsKey(day))
                    {   
                        D[day].Add(e);
                    }else{
                        D.Add(day, new List<ReaderEvent>());
                        D[day].Add(e);
                    }
                }

                
                if(dayCounts.ContainsKey(day))
                {
                    dayCounts[day]++;
                }else{
                    dayCounts.Add(day, 1);
                }
            }

    
            int mostActive = 0;
            foreach(KeyValuePair<DayOfWeek, List<ReaderEvent>> k in D)
            {
                if(k.Value.Count()/dayCounts[k.Key] > mostActive)
                {
                    mostActiveDay = k.Key;
                    mostActive = k.Value.Count()/dayCounts[k.Key];
                }
                Console.WriteLine(k.Key + " " + k.Value.Count());
            }
            foreach(KeyValuePair<DayOfWeek, int> i in dayCounts)
            {
                Console.WriteLine(i.Key + " " + i.Value);
            }

        }
        return mostActiveDay;

    }

    public List<ChartSeries> getChartData()
    {
        if(chartStartDate.Equals(""))
        {
            chartStartDate = FileStorage.DateDictionary.Keys.First();
            chartEndDate = FileStorage.DateDictionary.Keys.Last();
        }
        double[] countsPerDay = new double[FileStorage.DateDictionary.Count()];
        int count = 0;
        foreach(KeyValuePair<string, List<ReaderEvent>> r in FileStorage.DateDictionary)
        {
            countsPerDay[count] = r.Value.Count();
            count++;
        }

        return new List<ChartSeries>{new ChartSeries{Name = "Scans per day", Data = countsPerDay}};
    }

    public string[] getChartLabels()
    {
        string[] returnArray; 
        if(DictionariesCreated){
            returnArray = FileStorage.DateDictionary.Keys.ToArray();
            axisChartOptions.MatchBoundsToSize = true;
        }else{
            returnArray = new string[]{"No Data Uploaded"};
        }

        return returnArray;
    }
}